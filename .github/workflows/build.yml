name: Build and Package GenEvolve3D Application with Docker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docker-build-and-package:
    runs-on: windows-latest

    env:
      DOCKER_IMAGE_NAME: genevolve3d
      DOCKER_IMAGE_TAG: latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Convert Repository Name to Lowercase
        run: echo "DOCKER_IMAGE_NAME_LOWER=$(echo $DOCKER_IMAGE_NAME | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build Docker Image
        run: docker build -t $DOCKER_IMAGE_NAME_LOWER:$DOCKER_IMAGE_TAG .
        if: success()

      - name: Run Application in Docker Container
        run: docker run --name $DOCKER_IMAGE_NAME_LOWER $DOCKER_IMAGE_NAME_LOWER:$DOCKER_IMAGE_TAG
        if: success()

      # Optional: Push the Docker image to a registry like Docker Hub or GitHub Container Registry
      - name: Log in to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Push Docker Image to Registry
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: docker push $DOCKER_IMAGE_NAME_LOWER:$DOCKER_IMAGE_TAG

      # Optional: Cache Docker layers for faster builds
      - name: Cache Docker Layers
        if: success()
        uses: actions/cache@v2
        with:
          path: ~/.docker
          key: docker-layers-${{ runner.os }}-${{ hashFiles('**/Dockerfile') }}
